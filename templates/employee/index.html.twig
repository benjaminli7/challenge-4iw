{% extends 'base_employee.html.twig' %}

{% block body %}

    <div class="container mx-auto">
        <h1 class="text-2xl font-bold mb-4">Orders</h1>
        <h2 class="font-bold text-lg mb-2">ONGOING</h2>
        <div class="grid grid-cols-3 gap-4">
            {% for order in orders|sort((a, b) => b.id <=> a.id) %}
                {% if order.status == 'ONGOING' %}
                    <div id="to-pick-up-{{ order.id }}" class="bg-white rounded-lg shadow-md p-4">
                        <h2  class="font-bold text-lg mb-2">#{{ order.id }}</h2>
                        {% set total_price = 0 %}
                        {% for orderArticle in order.orderArticles %}
                            <div class="mb-2">
                                <span class="font-bold">{{ orderArticle.article.name }}</span> (x{{ orderArticle.quantity }}) - {{ orderArticle.article.price }} €
                            </div>
                            {% set total_price = total_price + orderArticle.article.price * orderArticle.quantity %}
                        {% endfor %}
                        <div class="text-sm mb-2">Total Price: {{ total_price }} €</div>
                        <div class="text-sm mb-2">Order Number: {{ order.id }}</div>
                        <button id="ongoing-order-{{ order.id }}"  class="bg-blue-500 text-white py-2 px-4 rounded-md" onclick="updateOrderStatus({{ order.id }}, 'TO_PICK_UP')">A récupérer</button>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <h2 class="font-bold text-lg mb-2">TO PICK UP</h2>
        <div id="to-pick-up" class="grid grid-cols-3 gap-4">
            {% for order in orders %}
                {% if order.status != 'ONGOING' %}
                    <div id="to-pick-up-{{ order.id }}" class="bg-white rounded-lg shadow-md p-4">
                        <h2 class="font-bold text-lg mb-2">#{{ order.id }}</h2>
                        {% set total_price = 0 %}
                        {% for orderArticle in order.orderArticles %}
                            <div class="mb-2">
                                <span class="font-bold">{{ orderArticle.article.name }}</span> (x{{ orderArticle.quantity }}) - {{ orderArticle.article.price }} €
                            </div>
                            {% set total_price = total_price + orderArticle.article.price * orderArticle.quantity %}
                        {% endfor %}
                        <div class="text-sm mb-2">Total Price: {{ total_price }} €</div>
                        <div class="text-sm mb-2">Order Number: FR1200{{ order.id }}</div>
                        {% if order.status == 'TO_PICK_UP' %}
                            <button id="to-pick-up-order-{{ order.id }}" class="bg-green-500 text-white py-2 px-4 rounded-md" onclick="updateOrderStatus({{ order.id }}, 'DONE')">Terminé</button>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    <script>
        function updateOrderStatus(orderId, status) {
            fetch(`/employee/order/${orderId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: status
                })
            })
                .then(response => {
                    if (response.ok) {
                        console.log("response:", response);
                        // console.log interesting stuff in the response



                        return response.json();
                    } else {
                        throw new Error('Something went wrong');
                    }
                })
                .then(order => {

                    const pickUpButton = document.querySelector(`#ongoing-order-${orderId}`);
                    if (pickUpButton) {
                        pickUpButton.innerHTML = 'Terminé';
                        pickUpButton.classList.remove('bg-blue-500');
                        pickUpButton.classList.add('bg-green-500');
                        pickUpButton.setAttribute('onclick', `updateOrderStatus(${orderId}, 'DONE')`);
                        pickUpButton.id = `to-pick-up-order-${orderId}`;

                        const parent = pickUpButton.closest(`#to-pick-up-${orderId}`);
                        if (parent) {
                            const toPickUp = document.querySelector('#to-pick-up');
                            if (toPickUp) {
                                parent.id = `to-pick-up-${orderId}`;
                                toPickUp.appendChild(parent);
                            }
                        }
                    } else {
                        const doneButton = document.querySelector(`#to-pick-up-${orderId}`);
                        console.log(doneButton);
                        if (doneButton) {
                            console.log(doneButton);
                            doneButton.closest(`#to-pick-up-${orderId}`).remove();
                        }
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        }
    </script>

{% endblock %}
